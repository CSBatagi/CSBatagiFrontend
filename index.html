<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Stats Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Darker gray text */
        }

        /* --- General Styles --- */
        /* Hide inactive page content */
        .page-content.hidden {
            display: none;
        }
        /* Ensure hidden class works */
        .hidden {
           display: none !important; /* Use important to override potential inline styles if needed */
        }

        /* Simple spinner (used for button) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Wheel spinner (SVG Container - for "Teker Döndü") */
        .wheel-spinner {
            display: inline-block;
            width: 20px; /* Adjust size as needed */
            height: 20px;
            /* Removed border properties */
            animation: spin 1.5s linear infinite; /* Apply spin animation, maybe slightly slower */
            vertical-align: middle; /* Align with text */
            margin-left: 0.5rem; /* Add some space */
            /* Color is now set dynamically via JS */
            /* color: #4b5563; */ /* Default color removed */
        }
        /* Ensure SVG inside fills the container */
        .wheel-spinner svg {
             width: 100%;
             height: 100%;
        }


        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Table Styles (Light Theme) --- */
        th, td {
            padding: 12px 15px;
            text-align: left; /* Default alignment */
            border-bottom: 1px solid #e5e7eb; /* Lighter border */
            vertical-align: middle; /* Ensure vertical alignment */
        }
        th {
            background-color: #f9fafb; /* Very light gray background for header */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #374151; /* Medium-dark gray header text */
        }
        tbody tr:hover {
            background-color: #f9fafb; /* Light hover effect for rows */
        }

        /* --- Responsive adjustments for mobile (max-width: 640px) --- */
        @media (max-width: 640px) {
            /* Adjust table padding and font size */
            th, td {
                padding: 8px 6px; /* Reduced horizontal padding */
                font-size: 0.875rem; /* text-sm */
            }
            /* Reduce size of attendance control elements */
            .attendance-control-container {
                flex-wrap: nowrap; /* Prevent wrapping */
                gap: 0.25rem; /* Reduced gap (space-x-1) */
            }
            .attendance-label {
                 width: 64px; /* Reduced fixed width (w-16) */
                 padding-top: 0.25rem; /* py-1 */
                 padding-bottom: 0.25rem; /* py-1 */
                 font-size: 0.75rem; /* text-xs, make text smaller */
                 cursor: pointer; /* Add pointer cursor to indicate clickability */
                 /* Removed horizontal padding */
            }
            .attendance-arrow {
                width: 1.5rem; /* Reduced size (w-6) */
                height: 1.5rem; /* Reduced size (h-6) */
            }
            .attendance-arrow svg {
                 width: 0.75rem; /* Smaller icon (w-3) */
                 height: 0.75rem; /* Smaller icon (h-3) */
            }
            /* Adjust player name/status columns if needed */
            /* Example: allow player name to wrap */
             td:first-child { /* Target player name cell */
                white-space: normal;
             }
             /* Adjust summary font size and padding */
             #attendance-summary {
                font-size: 1rem; /* text-base */
                padding: 0.5rem 1rem; /* py-2 px-4 */
             }
             /* Adjust wheel spinner size on mobile */
             .wheel-spinner {
                width: 16px;
                height: 16px;
             }
        }

        /* --- Info Panel Styles (Light Theme) --- */
        .info-panel {
            background-color: #ffffff; /* White background */
            padding: 1.5rem;
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            border: 1px solid #e5e7eb; /* Light border */
        }
        .info-panel h3 {
            color: #2563eb; /* Blue accent for heading */
            border-bottom: 1px solid #e5e7eb; /* Lighter border */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .info-panel p {
            margin-bottom: 0.5rem;
            color: #4b5563; /* Slightly lighter text */
        }
        .info-panel strong {
            color: #374151; /* Medium-dark gray text for labels */
        }

        /* --- Tab Navigation Styles (Light Theme) --- */
        .tab-nav-item {
            padding: 0.75rem 1rem; /* Adjusted padding slightly */
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #6b7280; /* Default tab color (gray) */
            font-weight: 500;
            white-space: nowrap; /* Prevent wrapping */
            display: inline-block; /* Ensure proper spacing and border */
        }
        .tab-nav-item:hover {
            color: #1f2937; /* Darker color on hover */
            border-bottom-color: #d1d5db; /* Subtle border on hover */
        }
        .tab-nav-item.active {
            color: #2563eb; /* Active tab color (blue) */
            border-bottom-color: #2563eb; /* Active tab border color */
            font-weight: 600;
        }

        /* --- Mobile Navigation Styles --- */
        /* Container when mobile menu is active */
        #main-nav-links.mobile-menu-active {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 100%; /* Position below the header */
            left: 0;
            right: 0;
            background-color: white;
            z-index: 20;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            border-radius: 0 0 0.375rem 0.375rem; /* rounded-b-md */
        }
        /* Individual links in mobile menu */
        #main-nav-links.mobile-menu-active .tab-nav-item {
            display: block; /* Make links block level */
            padding: 0.75rem 1rem; /* Consistent padding */
            border-bottom: 1px solid #e5e7eb; /* Separator */
            border-left: 3px solid transparent; /* For active state indicator */
            border-bottom-color: #e5e7eb; /* Override bottom border from desktop */
            color: #374151; /* Default text color */
            font-weight: 500;
        }
        #main-nav-links.mobile-menu-active .tab-nav-item:last-child {
            border-bottom: none; /* Remove border from last item */
        }
        /* Active link style in mobile menu */
        #main-nav-links.mobile-menu-active .tab-nav-item.active {
            color: #2563eb; /* Active tab color (blue) */
            border-left-color: #2563eb; /* Active tab border color */
            background-color: #eff6ff; /* Light blue background (blue-50) */
            border-bottom-color: #e5e7eb !important; /* Ensure bottom border remains consistent */
            font-weight: 600;
        }

        /* --- Basic Button Style (Light Theme) --- */
        .action-button {
            background-color: #2563eb; /* Blue */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 500;
            display: inline-flex; /* Align spinner correctly */
            align-items: center;
            justify-content: center;
        }
        .action-button:hover {
            background-color: #1d4ed8; /* Darker Blue */
        }
        .action-button:disabled {
            background-color: #9ca3af; /* Gray when disabled */
            cursor: not-allowed;
        }
        .action-button:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); /* Ring focus */
        }


        /* --- Message Area (Light Theme) --- */
        #message-area {
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            border-width: 1px;
            border-style: solid;
            max-width: 42rem; /* max-w-lg */
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        #message-area.success {
            background-color: #dcfce7; color: #166534; border-color: #86efac; /* Green */
        }
        #message-area.error {
            background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; /* Red */
        }

        /* --- General Page Content Container Style --- */
        .page-content-container {
            background-color: #ffffff;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* shadow-sm */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }

        /* --- Attendance Control Styles --- */
        .attendance-control-container {
            display: flex;
            align-items: center;
            justify-content: center; /* Center the control */
            gap: 0.5rem; /* space-x-2 - Default gap */
        }
        .attendance-arrow {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem; /* w-8 - Default size */
            height: 2rem; /* h-8 - Default size */
            border-radius: 9999px; /* rounded-full */
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #4b5563; /* text-gray-600 */
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid #d1d5db; /* Add subtle border */
        }
        .attendance-arrow:hover {
            background-color: #d1d5db; /* bg-gray-300 */
        }
        .attendance-arrow:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.5); /* Ring focus gray */
        }
        .attendance-arrow svg {
            width: 1rem; /* w-4 - Default icon size */
            height: 1rem; /* h-4 - Default icon size */
        }
        .attendance-label {
            display: inline-flex; /* Use inline-flex for centering */
            align-items: center;
            justify-content: center;
            width: 76px; /* Fixed width as requested */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            border-radius: 9999px; /* rounded-full */
            font-weight: 500; /* font-medium */
            text-align: center;
            line-height: 1; /* leading-none */
            font-size: 0.875rem; /* text-sm - Default font size */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            cursor: pointer; /* Add pointer cursor to indicate clickability */
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto max-w-7xl"> <header class="relative mb-6">
            <div class="flex justify-between items-center border-b border-gray-300 pb-3">
                <div class="flex items-center">
                    <img src="BatakLogo.png"
                         alt="Gaming Group Logo"
                         class="h-10 w-10 mr-2 object-contain"
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/e0e0e0/333?text=Logo';">
                    <h1 class="text-2xl md:text-3xl font-bold text-blue-700">CS Batağı Gururla Sunar</h1>
                </div>
                <button id="menu-button" type="button" class="md:hidden p-2 inline-flex items-center justify-center rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500" aria-controls="main-nav-links" aria-expanded="false">
                    <span class="sr-only">Open main menu</span>
                    <svg id="icon-hamburger" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <svg id="icon-close" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <nav id="main-nav-links" class="hidden md:flex md:flex-wrap md:items-center md:border-b md:border-gray-300 md:-mb-px md:mt-2" aria-label="Main navigation">
                 <a class="tab-nav-item" data-page="attendance" href="#">ATTENDANCE</a>
                <a class="tab-nav-item" data-page="draft" href="#">DRAFT</a>
                <a class="tab-nav-item" data-page="pick" href="#">PICK</a>
                <a class="tab-nav-item" data-page="batak_domination" href="#">BATAK DOMINATION</a>
                <a class="tab-nav-item" data-page="sonmac" href="#">SONMAC</a>
                <a class="tab-nav-item" data-page="duel_sonmac" href="#">DUEL_SONMAC</a>
                <a class="tab-nav-item" data-page="gece_ortalama" href="#">Nightly Avg</a>
                <a class="tab-nav-item" data-page="last10" href="#">Last 10 Rank</a>
                <a class="tab-nav-item" data-page="hltv2" href="#">HLTV2 Perf</a>
                <a class="tab-nav-item" data-page="adr" href="#">ADR Perf</a>
                <a class="tab-nav-item" data-page="season_rank" href="#">Season Rank</a>
            </nav>
        </header>

        <div class="text-center mb-6">
             <button id="update-stats-button" class="action-button">
                 Update Attendance from Sheet
                 <span id="spinner" class="spinner hidden"></span>
             </button>
        </div>

        <div id="message-area" class="hidden" role="alert" aria-live="polite"></div>

        <div id="page-content-area">

            <div id="page-attendance" class="page-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                    <div class="lg:col-span-2 page-content-container overflow-x-auto"> <h2 class="text-2xl font-semibold mb-1 text-blue-600">Player Status</h2>
                        <div id="attendance-summary" class="text-lg font-semibold mb-4 flex items-center justify-center text-center px-4 py-2 rounded-md transition-colors duration-300">
                            <span id="summary-text">Loading summary...</span>
                            <span id="teker-dondu-indicator" class="wheel-spinner hidden" title="Teker Döndü!">
                                 <svg aria-hidden="true" focusable="false" role="img" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                     <path fill="currentColor" fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                                 </svg>
                             </span>
                             </div>
                        <table class="min-w-full divide-y divide-gray-200"> <colgroup> <col style="width: 30%;">
                                <col style="width: 30%;">
                                <col style="width: 40%;">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th scope="col">Player</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" class="text-center">Attendance</th>
                                </tr>
                            </thead>
                            <tbody id="player-list" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="3" class="text-center py-4 text-gray-500">Loading players...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="info-panel lg:col-span-1">
                         <h3 class="text-xl font-semibold">Schedule & Info</h3>
                         <p><strong>Confirmation Deadline:</strong> 21:00</p>
                         <p><strong>Team Setup:</strong> 21:15 - 21:45</p>
                         <p><strong>Be Online By:</strong> 21:45</p>
                         <p><strong>Match Start:</strong> 22:00</p>
                         <hr class="border-gray-200 my-4">
                         <h4 class="text-lg font-semibold mb-2 text-blue-600">Drafting Rules</h4>
                         <ul class="list-disc list-inside text-sm space-y-1 text-gray-600">
                             <li>Coin toss winner chooses first pick OR gives first pick away.</li>
                             <li>Picks follow 1-2-2-2-2-1 format.</li>
                             <li>Reroll if teams seem unbalanced.</li>
                             <li>Coin toss loser picks 2nd & 3rd map bans.</li>
                             <li>Coin toss winner picks 1st map ban.</li>
                             <li>Coin toss winner chooses side on Map 1 & 3.</li>
                             <li>Coin toss loser chooses side on Map 2.</li>
                         </ul>
                    </div>
                </div>
            </div>

            <div id="page-draft" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Draft Page</h2>
                <p class="mt-4 text-gray-700">Content for the Draft page will go here...</p>
                <div id="draft-data-content" class="mt-4"></div>
            </div>
             <div id="page-pick" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Pick Page</h2>
                <p class="mt-4 text-gray-700">Content for the Pick page will go here...</p>
                 <div id="pick-data-content" class="mt-4"></div>
            </div>
            <div id="page-batak_domination" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Batak Domination Page</h2>
                <p class="mt-4 text-gray-700">Content for the Batak Domination stats will go here...</p>
                 <div id="batak-data-content" class="mt-4"></div>
            </div>
            <div id="page-sonmac" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Sonmac Page</h2>
                <p class="mt-4 text-gray-700">Sonmac stats will be loaded here when updated.</p>
                <div id="sonmac-data-content" class="overflow-x-auto mt-4"></div>
            </div>
            <div id="page-duel_sonmac" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Duel Sonmac Page</h2>
                <p class="mt-4 text-gray-700">Content for the Duel Sonmac stats will go here...</p>
                 <div id="duel-sonmac-data-content" class="mt-4"></div>
            </div>
            <div id="page-gece_ortalama" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Nightly Average Stats</h2>
                <p class="mt-4 text-gray-700">Content for the Nightly Average stats will go here...</p>
                 <div id="nightly-avg-data-content" class="mt-4"></div>
            </div>
            <div id="page-last10" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Last 10 Games Ranking</h2>
                <p class="mt-4 text-gray-700">Last 10 games ranking will be loaded here when updated.</p>
                 <div id="last10-data-content" class="overflow-x-auto mt-4"></div>
            </div>
             <div id="page-hltv2" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">HLTV 2.0 Performance</h2>
                <p class="mt-4 text-gray-700">Content for the HLTV 2.0 Performance stats will go here...</p>
                 <div id="hltv2-data-content" class="mt-4"></div>
            </div>
             <div id="page-adr" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">ADR Performance</h2>
                <p class="mt-4 text-gray-700">Content for the ADR Performance stats will go here...</p>
                 <div id="adr-data-content" class="mt-4"></div>
            </div>
             <div id="page-season_rank" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Season Ranking</h2>
                <p class="mt-4 text-gray-700">Content for the Season Ranking stats will go here...</p>
                 <div id="season-rank-data-content" class="mt-4"></div>
            </div>

        </div> </div> <script>
        // --- Constants ---
        const APPS_SCRIPT_URL = 'https://royal-flower-aa89.onur1atak.workers.dev/'; // Replace with your actual URL
        const ATTENDANCE_STATES = ["not_coming", "no_response", "coming"]; // Order matters for cycling
        const DEFAULT_PAGE = 'attendance';
        const TEKER_DONDU_THRESHOLD = 10; // Number of players needed for the wheel

        // --- State ---
        let players = []; // Initialize empty, will be filled by fetch
        let currentTimeoutId = null; // To manage message timeout

        // --- DOM Elements ---
        const playerListBody = document.getElementById('player-list');
        const pageContentArea = document.getElementById('page-content-area');
        const updateButton = document.getElementById('update-stats-button');
        const messageArea = document.getElementById('message-area');
        const spinner = document.getElementById('spinner');
        // Updated summary elements
        const attendanceSummaryDiv = document.getElementById('attendance-summary');
        const summaryTextSpan = document.getElementById('summary-text');
        const tekerDonduIndicator = document.getElementById('teker-dondu-indicator');
        // Nav elements
        const menuButton = document.getElementById('menu-button');
        const navLinksContainer = document.getElementById('main-nav-links');
        const navLinks = navLinksContainer.querySelectorAll('.tab-nav-item');
        const iconHamburger = document.getElementById('icon-hamburger');
        const iconClose = document.getElementById('icon-close');

        // --- Helper Functions ---

        /**
         * Displays a message to the user (success or error).
         * @param {string} text - The message text.
         * @param {'success' | 'error'} type - The type of message.
         * @param {number} duration - How long to show the message in ms.
         */
        function showMessage(text, type = 'error', duration = 5000) {
            // Clear previous timeout if exists
            if (currentTimeoutId) {
                clearTimeout(currentTimeoutId);
            }

            messageArea.textContent = text;
            // Reset classes, keeping base ones if needed (like hidden initially)
            messageArea.className = 'hidden'; // Start hidden
            messageArea.classList.add(type); // Add 'success' or 'error' class
            messageArea.classList.remove('hidden'); // Make visible

            // Set timeout to hide the message
            currentTimeoutId = setTimeout(() => {
                messageArea.classList.add('hidden');
                messageArea.classList.remove(type);
                currentTimeoutId = null; // Reset timeout ID
            }, duration);
        }

        /**
         * Renders the player list in the table and updates the summary.
         */
        function renderPlayers() {
            // Ensure required DOM elements exist
            if (!playerListBody || !attendanceSummaryDiv || !summaryTextSpan || !tekerDonduIndicator) {
                console.error("Required DOM elements for rendering players/summary are missing.");
                return;
            }
            playerListBody.innerHTML = ''; // Clear existing rows

            // Define default summary state
            let summaryBgClass = 'bg-red-100';
            let summaryTextClass = 'text-red-800';
            let wheelColorClass = 'text-red-800'; // Match wheel color to text

            // Handle case where player data is not available
            if (players.length === 0) {
                 playerListBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No player data available. Try updating.</td></tr>';
                 summaryTextSpan.textContent = 'Gelen oyuncu: 0  Belirsiz: 0';
                 tekerDonduIndicator.classList.add('hidden'); // Ensure indicator is hidden
            } else {
                // Calculate counts
                let countComing = 0;
                let countNoResponse = 0;
                players.forEach(player => {
                    if (player.attendance === 'coming') countComing++;
                    if (player.attendance === 'no_response') countNoResponse++;
                });

                // Update summary text
                summaryTextSpan.textContent = `Gelen oyuncu: ${countComing}  Belirsiz: ${countNoResponse}`;

                // Determine background/text colors and Show/hide the "Teker Döndü" indicator
                if (countComing >= TEKER_DONDU_THRESHOLD) {
                    summaryBgClass = 'bg-green-100';
                    summaryTextClass = 'text-green-800';
                    wheelColorClass = 'text-green-800'; // Match wheel color
                    tekerDonduIndicator.classList.remove('hidden');
                } else {
                    // Keep default red colors defined above
                    tekerDonduIndicator.classList.add('hidden');
                }
            }

            // Apply summary styles
            // Remove potentially existing color classes first
            attendanceSummaryDiv.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'text-gray-700');
            tekerDonduIndicator.classList.remove('text-green-800', 'text-red-800', 'text-gray-600'); // Remove potential wheel colors

            // Add the determined classes
            attendanceSummaryDiv.classList.add(summaryBgClass, summaryTextClass);
            if (!tekerDonduIndicator.classList.contains('hidden')) {
                 tekerDonduIndicator.classList.add(wheelColorClass);
            }


            // Define attendance state configurations (styles and text)
            const stateConfigs = {
                coming: { text: 'Geliyor', bgColor: 'bg-green-500', textColor: 'text-white' },
                not_coming: { text: 'Gelmiyor', bgColor: 'bg-red-500', textColor: 'text-white' },
                no_response: { text: 'Belirsiz', bgColor: 'bg-gray-300', textColor: 'text-gray-900' }
            };

            // Create and append rows for each player (only if players exist)
            if (players.length > 0) {
                players.forEach((player) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-player-name', player.name);

                    // 1) Name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'font-medium text-gray-900 whitespace-nowrap'; // Keep nowrap on larger screens
                    nameCell.textContent = player.name;
                    row.appendChild(nameCell);

                    // 2) Status cell
                    const statusCell = document.createElement('td');
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'px-2 py-1 text-xs font-medium rounded-full whitespace-nowrap'; // Adjusted padding/size

                    // --- Status Text Logic ---
                    let displayStatus = 'Unknown'; // Default display text
                    const originalStatus = (player.status || '').toLowerCase(); // Get original status safely

                    if (originalStatus.includes('aktif')) {
                        displayStatus = 'Aktif Oyuncu'; // Simplified active text
                    } else if (originalStatus === 'adam evde yok') {
                        displayStatus = 'Evde Yok'; // Simplified inactive text as requested
                    } else if (player.status) {
                        displayStatus = player.status; // Use original if not recognized but exists
                    }
                    statusBadge.textContent = displayStatus;
                    // --- End Status Text Logic ---


                    // Color-code the status badge based on the *original* status logic
                    if (originalStatus.includes('aktif')) {
                        statusBadge.classList.add('bg-green-100', 'text-green-800');
                    } else if (originalStatus === 'adam evde yok' || originalStatus.includes('inactive')) { // Check original logic conditions
                        statusBadge.classList.add('bg-red-100', 'text-red-800');
                    } else {
                        statusBadge.classList.add('bg-gray-100', 'text-gray-800'); // Default/Unknown style
                    }
                    statusCell.appendChild(statusBadge);
                    row.appendChild(statusCell);

                    // 3) Attendance cell (using the improved control)
                    const attendanceCell = document.createElement('td');
                    attendanceCell.className = 'text-center'; // Center content within the cell

                    const currentState = player.attendance || 'no_response'; // Default if missing
                    const config = stateConfigs[currentState];

                    // Container for the control
                    const container = document.createElement('div');
                    container.className = 'attendance-control-container'; // Centered flex container

                    // Left arrow button (using SVG)
                    const leftArrowBtn = document.createElement('button');
                    leftArrowBtn.className = 'attendance-arrow';
                    leftArrowBtn.setAttribute('aria-label', `Previous status for ${player.name}`);
                    leftArrowBtn.setAttribute('data-direction', 'left');
                    leftArrowBtn.setAttribute('data-player', player.name);
                    leftArrowBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`; // Left chevron SVG

                    // Status pill label - Apply fixed width via inline style or Tailwind arbitrary value class
                    const labelSpan = document.createElement('span');
                    // Apply base classes and dynamic background/text color
                    labelSpan.className = `attendance-label ${config.bgColor} ${config.textColor}`;
                    // Add fixed width style directly (alternative: use w-[76px] in className)
                    // labelSpan.style.width = '76px'; // Apply fixed width directly
                    labelSpan.textContent = config.text;
                    labelSpan.setAttribute('data-state', currentState); // Store current state
                    labelSpan.setAttribute('data-player', player.name); // Link to player

                    // Right arrow button (using SVG)
                    const rightArrowBtn = document.createElement('button');
                    rightArrowBtn.className = 'attendance-arrow';
                    rightArrowBtn.setAttribute('aria-label', `Next status for ${player.name}`);
                    rightArrowBtn.setAttribute('data-direction', 'right');
                    rightArrowBtn.setAttribute('data-player', player.name);
                    rightArrowBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`; // Right chevron SVG

                    // Append elements to the container
                    container.appendChild(leftArrowBtn);
                    container.appendChild(labelSpan);
                    container.appendChild(rightArrowBtn);

                    // Append the container to the cell
                    attendanceCell.appendChild(container);
                    row.appendChild(attendanceCell);

                    // Add the row to the table body
                    playerListBody.appendChild(row);
                });
            } // End player loop
        }

        /**
         * Fetches attendance data from the Google Apps Script endpoint.
         */
        async function fetchStatsFromSheet() {
            spinner.classList.remove('hidden');
            updateButton.disabled = true;
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                if (!response.ok) {
                    // Try to get more specific error from response body if possible
                    let errorDetails = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorDetails += ` - ${errorData.message || JSON.stringify(errorData)}`;
                    } catch (e) { /* Ignore if response is not JSON */ }
                    throw new Error(errorDetails);
                }
                const data = await response.json();
                // Basic validation: Check if it's an array
                if (!Array.isArray(data)) {
                    console.error("Received data is not an array:", data);
                    throw new Error("Invalid data format received from server.");
                }
                players = data; // Update the global players array
                renderPlayers(); // Re-render the table with new data
                showMessage('Attendance data loaded successfully!', 'success');
            } catch (err) {
                console.error('Failed to fetch stats:', err);
                showMessage(`Error loading data: ${err.message}`, 'error');
                // Optionally render with empty state or keep old data
                 renderPlayers(); // Render even on error to show empty state or previous data
            } finally {
                spinner.classList.add('hidden');
                updateButton.disabled = false;
            }
        }

        /**
         * Sends an attendance update for a specific player to the Google Apps Script endpoint.
         * @param {string} playerName - The name of the player to update.
         * @param {string} newAttendance - The new attendance status ('coming', 'not_coming', 'no_response').
         */
        async function updateAttendanceInSheet(playerName, newAttendance) {
            // Optional: Add visual feedback (e.g., temporary spinner on the row)
            console.log(`Attempting to update ${playerName} to ${newAttendance}`);
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    // Use 'no-cors' if your Apps Script is not configured for CORS preflight (simple requests)
                    // mode: 'no-cors', // Uncomment if needed, but you won't get response details back
                    headers: {
                        // 'Content-Type': 'application/json' // Needed for standard CORS
                        'Content-Type': 'text/plain;charset=utf-8', // Often needed for simple 'no-cors' POST to Apps Script
                    },
                    // Body needs to be stringified for application/json or simple text for text/plain
                     body: JSON.stringify({ name: playerName, attendance: newAttendance }),
                    // Example for text/plain if Apps Script expects that:
                    // body: `name=${encodeURIComponent(playerName)}&attendance=${encodeURIComponent(newAttendance)}`
                });

                // Note: With 'no-cors', response.ok will likely be false even on success.
                // You might need to rely on the absence of network errors.
                // If using standard CORS (recommended):
                 if (!response.ok) {
                     let errorText = `Network response was not ok (Status: ${response.status})`;
                     try {
                        // Try to parse error response if server sends JSON errors
                        const errorData = await response.json();
                        errorText += `: ${errorData.message || JSON.stringify(errorData)}`;
                     } catch(e) {
                        // Fallback if error response isn't JSON
                        errorText = await response.text();
                     }
                     throw new Error(errorText);
                 }
                 // If using standard CORS and expecting JSON response:
                 // const result = await response.json();
                 // console.log('Update successful:', result);

                console.log(`Attendance updated successfully in sheet for ${playerName} to ${newAttendance}`);
                // Optional: Show temporary success message
                // showMessage(`${playerName}'s status updated!`, 'success', 2000);

            } catch (error) {
                console.error('Failed to update attendance in sheet:', error);
                showMessage(`Failed to update status for ${playerName}: ${error.message}`, 'error');
                // OPTIONAL: Revert the UI change if the update fails
                // To do this, you'd need to store the *previous* state before the optimistic update
                // and call fetchStatsFromSheet() or manually revert the specific player's state and re-render.
                // Example (simple refetch):
                // showMessage(`Update failed for ${playerName}. Reverting...`, 'error');
                // await fetchStatsFromSheet(); // Refetch to get the actual state from the sheet
            } finally {
                 // Optional: Remove row-specific spinner if added
            }
        }


        /**
         * Handles clicks within the player list table, specifically for attendance changes.
         * Uses event delegation. Detects clicks on arrows OR the label itself.
         * @param {Event} event - The click event object.
         */
        async function handlePlayerListClick(event) {
            const targetArrow = event.target.closest('.attendance-arrow');
            const targetLabel = event.target.closest('.attendance-label');
            let playerName = null;
            let direction = null; // 'left', 'right', or null if label clicked
            let playerIndex = -1;
            let isLabelClick = false;

            if (targetArrow) {
                // Clicked on an arrow button
                playerName = targetArrow.getAttribute('data-player');
                direction = targetArrow.getAttribute('data-direction');
            } else if (targetLabel) {
                 // Clicked directly on the label pill
                 isLabelClick = true;
                 playerName = targetLabel.getAttribute('data-player');
                 // Determine direction based on click position
                 const rect = targetLabel.getBoundingClientRect();
                 const clickX = event.clientX - rect.left; // X position within the element
                 direction = (clickX < rect.width / 2) ? 'left' : 'right'; // Left half or right half
            }

            if (playerName) {
                playerIndex = players.findIndex(p => p.name === playerName);
            }

            if (playerIndex > -1 && direction) {
                // Common logic for both arrow and label clicks
                const currentState = players[playerIndex].attendance || 'no_response';
                let currentIndex = ATTENDANCE_STATES.indexOf(currentState);

                // Calculate the new index based on direction
                if (direction === 'left') {
                    currentIndex = (currentIndex - 1 + ATTENDANCE_STATES.length) % ATTENDANCE_STATES.length;
                } else { // 'right'
                    currentIndex = (currentIndex + 1) % ATTENDANCE_STATES.length;
                }

                const newState = ATTENDANCE_STATES[currentIndex];

                // Optimistic UI Update
                players[playerIndex].attendance = newState;
                renderPlayers(); // Update the UI

                // Asynchronously update the backend
                await updateAttendanceInSheet(playerName, newState);
            } else if (playerName && !direction) {
                 console.warn(`Could not determine click direction for player ${playerName}`);
            } else if (targetArrow || targetLabel) {
                 console.warn(`Player data not found for clicked element.`);
            }
            // If click was not on an arrow or label, do nothing.
        }


        // --- Navigation Logic ---

        /**
         * Shows the specified page content and updates navigation link styles.
         * @param {string} pageId - The ID of the page to show (e.g., 'attendance', 'draft').
         */
        function showPage(pageId) {
            const allPages = pageContentArea.querySelectorAll('.page-content');
            allPages.forEach(page => {
                page.classList.add('hidden'); // Hide all pages
            });

            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.remove('hidden'); // Show the target page
            } else {
                console.error(`Page content with ID 'page-${pageId}' not found.`);
                // Optionally show a default page or an error message
                document.getElementById(`page-${DEFAULT_PAGE}`)?.classList.remove('hidden');
                pageId = DEFAULT_PAGE; // Fallback to default
            }

            // Update navigation link active states
            navLinks.forEach(link => {
                link.classList.remove('active');
                // Remove mobile-specific active styles if they exist
                link.classList.remove('bg-blue-50', 'border-l-blue-500', 'text-blue-600'); // More specific removal

                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active'); // Add active class to the correct link
                    // Apply mobile-specific active styles if the menu is currently in mobile view
                    if (navLinksContainer.classList.contains('mobile-menu-active')) {
                         link.classList.add('bg-eff6ff', 'border-l-blue-600', 'text-blue-600'); // Use actual color codes if needed
                    }
                }
            });

            // If switching to attendance page, ensure players are rendered (might be redundant if already rendered)
            // if (pageId === 'attendance') {
            //     renderPlayers();
            // }

             // Close mobile menu after selecting an item (optional but good UX)
             if (navLinksContainer.classList.contains('mobile-menu-active')) {
                toggleMobileMenu(false); // Force close
             }
        }

        /**
         * Toggles the visibility and state of the mobile navigation menu.
         * @param {boolean} [forceState] - Optional. Force 'true' to open, 'false' to close.
         */
        function toggleMobileMenu(forceState) {
            const shouldBeOpen = forceState !== undefined ? forceState : menuButton.getAttribute('aria-expanded') === 'false';

            menuButton.setAttribute('aria-expanded', shouldBeOpen);
            iconHamburger.classList.toggle('hidden', shouldBeOpen);
            iconClose.classList.toggle('hidden', !shouldBeOpen);

            // Use Tailwind classes for visibility on mobile
            navLinksContainer.classList.toggle('hidden', !shouldBeOpen); // Hide if not open
             // Add/remove classes that define the mobile menu appearance
            navLinksContainer.classList.toggle('mobile-menu-active', shouldBeOpen);


            // Re-apply active styles correctly when opening/closing
            const activeLink = navLinksContainer.querySelector('.tab-nav-item.active');
            if (activeLink) {
                // Remove potentially incorrect mobile styles first
                activeLink.classList.remove('bg-eff6ff', 'border-l-blue-600', 'text-blue-600');
                if (shouldBeOpen) {
                    // Add mobile active styles only if opening
                     activeLink.classList.add('bg-eff6ff', 'border-l-blue-600', 'text-blue-600');
                }
            }
        }

        // --- Event Listeners ---

        // Initial load: Fetch data and show the default page
        document.addEventListener('DOMContentLoaded', () => {
            showPage(DEFAULT_PAGE); // Show the initial page
            fetchStatsFromSheet(); // Fetch initial data
            // Placeholder: Load data for other tabs if needed initially
            // loadOtherTabData('draft'); // Example
        });

        // Update button click
        updateButton.addEventListener('click', fetchStatsFromSheet);

        // Player list clicks (for attendance changes via event delegation)
        playerListBody.addEventListener('click', handlePlayerListClick);

        // Navigation link clicks (using event delegation on the container)
        navLinksContainer.addEventListener('click', (event) => {
            const link = event.target.closest('.tab-nav-item');
            if (link && link.dataset.page) { // Check if it's a valid nav link with a page target
                event.preventDefault(); // Prevent default anchor link behavior
                const pageId = link.dataset.page;
                showPage(pageId);
                 // Placeholder: Fetch data for the newly selected tab if necessary
                 // loadTabDataIfNeeded(pageId);
            }
        });

        // Mobile menu button click
        menuButton.addEventListener('click', () => toggleMobileMenu());

    </script>
</body>
</html>
